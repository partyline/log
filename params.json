{
  "name": "Log",
  "tagline": "Notes on server configuration",
  "body": "# Remplacer le RAID 1 par ZFS RAIDZ par sur serveur OVH \"So You Start\"\r\n\r\nCe serveur a trois disques SSD de 120 Go. La FAQ d'OVH indique que dans ce cas les disques sont en RAID 5.\r\n\r\n> Par défaut, si votre serveur dispose de 2 disques SATA (ou SSD) il sera installé avec un RAID 1 (RAID 5 si 3 disques SATA ou SSD). En RAID 1, les disques étant en miroir, vous disposerez de façon effective de la capacité d'un seul des disques.\r\n\r\nQuoi qu'il en soit, FreeBSD est un système de \"Tier 1\" pour le support de ZFS, autant en profiter et utiliser les 3 disques pour une installation \"Root on ZFS\". Cette configuration garantit que le système résiste à la défaillance d'un des disques durs et l'espace disponible est de 120 Go ce qui convient parfaitement pour des projets ne nécessitant pas des terabytes de données.\r\n\r\n## Désactiver le RAID\r\n\r\nPour désactiver le RAID, dans le manager OVH, choisir un template FreeBSD et sélectionner l'option «Installation Personnalisée.»\r\n\r\n![OVH Manager - Screenshot 1](https://raw.githubusercontent.com/partyline/log/gh-pages/img/ovh-1.png)\r\n\r\nCocher ensuite l'option pour «installer le système uniquement sur 1 disque»\r\n\r\n![OVH Manager - Screenshot 2](https://raw.githubusercontent.com/partyline/log/gh-pages/img/ovh-2.png)\r\n\r\n\r\n\r\n## Installer FreeBSD sur un pool zfs de 3 disques\r\n\r\nLa procédure la plus simple est d'utiliser mfsBSD pour installer FreeBSD selon cette configuration.\r\n\r\nmfsBSD est un ensemble de scripts permettant de créer une image bootable de FreeBSD qui est entièrement chargée dans la RAM. C'est un outil précieux grâce auquel on peut par exemple facilement installer un système FreeBSD sur un serveur n'offrant que des distributions Linux (mfsBSD a d'ailleurs été inspiré par un autre projet nommé depenguinator.)\r\n\r\nPour générer une image bootable, le script doit être lancé sur un système FreeBSD, il est possible de booter sur le serveur, puisqu'on y a installé FreeBSD 10, ou bien d'utiliser une machine virtuelle.\r\n\r\nRécupérer l'archive de mfsBSD et l'iso de FreeBSD\r\n```\r\nftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/amd64/ISO-IMAGES/10.3/FreeBSD-10.3-RELEASE-amd64-disc1.iso\r\nfetch http://github.com/mmatuska/mfsbsd/archive/2.2.tar.gz\r\n```\r\n\r\nConfigurer mfsBSD\r\n\r\nAu minimum, configurer l'interface réseau en DHCP (le temps de l'installation)\r\n\r\n```\r\ntar xzvf 2.2.tar.gz\r\ncd mfsbsd-2.2/conf\r\ncp rc.conf.sample rc.conf\r\nvi rc.conf\r\n```\r\n\r\nDécommenter la ligne `ifconfig_rl0=\"DHCP\"` et vérifier le nom de l'interface. Dans mon cas : `ifconfig_em0=\"DHCP\"`\r\n\r\n```\r\ncp loader.conf.sample loader.conf\r\nvi loader.conf\r\n```\r\nChanger le mot de passe root à la ligne `mfsbsd.rootpw=\"foobar\"` dans le fichier `loader.conf`.\r\n\r\nEn root\r\n```\r\n# mdconfig -a -t vnode -u 10 -f FreeBSD-10.3-RELEASE-amd64-disc1.iso\r\n# mkdir /media/cdrom\r\n# mount_cd9660 /dev/md10 /media/cdrom/\r\n# make PKG_STATIC=/usr/local/sbin/pkg-static BASE=/media/cdrom/usr/freebsd-dist\r\n```\r\n\r\n## Rebooter sur le système Rescue\r\n\r\nDans le manager d'OVH.\r\n\r\n![OVH Manager - Screenshot 3](https://raw.githubusercontent.com/partyline/log/gh-pages/img/ovh-3.png)\r\n\r\nCopier l'iso de mfsBSD sur le premier disque dur du serveur (ici `/dev/ada0`), avec `dd` via `ssh`\r\n\r\n```\r\ndd if=mfsbsd-10.3-RELEASE-amd64.img | ssh root@<your-ip> 'dd of=/dev/ada0 bs=1M'\r\n```\r\n\r\nOn reboote maintenant sur le disque dur du serveur (le changer dans le manager) qui va charger en mémoire mfsBSD et nous permettre d'utiliser les disques comme on l'entend !\r\n\r\n```\r\nFreeBSD 10.3-RELEASE (GENERIC) #0 r297264: Fri Mar 25 02:10:02 UTC 2016\r\n\r\nWelcome to mfsBSD, the memory based FreeBSD distribution.\r\n\r\nThis is a stripped-down version of FreeBSD without:\r\n- manual pages, info pages, examples\r\n- include files, static library files, development tools\r\n- bind binaries (host, dig, named, etc.)\r\n\r\nFeel free to email me with any bug reports or feature suggestions.\r\nMartin Matuska <mm@FreeBSD.org>\r\nhttp://mfsbsd.vx.sk/\r\n```\r\n\r\nPour un guide complet sur la façon de procéder se référer au [wiki](https://wiki.freebsd.org/RootOnZFS/GPTZFSBoot/Mirror) On peut aussi lancer l'installateur, choisir l'option ZFS on root guided\r\n```\r\n# bsdinstall\r\n```\r\n![bsdinstall - Screenshot 1](https://raw.githubusercontent.com/partyline/log/gh-pages/img/bsdinstall-1.png)\r\n![bsdinstall - Screenshot 2](https://raw.githubusercontent.com/partyline/log/gh-pages/img/bsdinstall-2.png)\r\n![bsdinstall - Screenshot 3](https://raw.githubusercontent.com/partyline/log/gh-pages/img/bsdinstall-3.png)\r\n```\r\n% gpart show\r\n=>       34  234441581  ada0  GPT  (112G)\r\n         34          6        - free -  (3.0K)\r\n         40       1024     1  freebsd-boot  (512K)\r\n       1064        984        - free -  (492K)\r\n       2048   25165824     2  freebsd-swap  (12G)\r\n   25167872  209272832     3  freebsd-zfs  (100G)\r\n  234440704        911        - free -  (456K)\r\n\r\n=>       34  234441581  ada1  GPT  (112G)\r\n         34          6        - free -  (3.0K)\r\n         40       1024     1  freebsd-boot  (512K)\r\n       1064        984        - free -  (492K)\r\n       2048   25165824     2  freebsd-swap  (12G)\r\n   25167872  209272832     3  freebsd-zfs  (100G)\r\n  234440704        911        - free -  (456K)\r\n\r\n=>       34  234441581  ada2  GPT  (112G)\r\n         34          6        - free -  (3.0K)\r\n         40       1024     1  freebsd-boot  (512K)\r\n       1064        984        - free -  (492K)\r\n       2048   25165824     2  freebsd-swap  (12G)\r\n   25167872  209272832     3  freebsd-zfs  (100G)\r\n  234440704        911        - free -  (456K)\r\n```\r\n\r\n```\r\nzpool status\r\n  pool: zroot\r\n state: ONLINE\r\n  scan: none requested\r\nconfig:\r\n\r\n\tNAME        STATE     READ WRITE CKSUM\r\n\tzroot       ONLINE       0     0     0\r\n\t  raidz1-0  ONLINE       0     0     0\r\n\t    ada0p3  ONLINE       0     0     0\r\n\t    ada1p3  ONLINE       0     0     0\r\n\t    ada2p3  ONLINE       0     0     0\r\n\r\nerrors: No known data errors\r\n```\r\n### So You Start\r\nUne gamme intermédiaire de serveurs dédiés chez OVH à des tarifs intéressants.[e3-ssd-2](https://www.soyoustart.com/en/offers/e3-ssd-2.xml)\r\n\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}